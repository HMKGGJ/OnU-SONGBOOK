<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>회원정보 | 온유ONU 노래책</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #fdfbfb 0%, #ebedee 100%);
      font-family: 'Inter', sans-serif;
      color: #2d3748;
    }
    .glass {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(12px);
      border-radius: 2rem;
      border: 1px solid rgba(162,28,175,0.14);
      box-shadow: 0 8px 40px rgba(78,205,196,0.09);
    }
    .main-title {
      background: linear-gradient(45deg, #6366f1, #8b5cf6, #ec4899, #f59e0b);
      background-size: 300% 300%;
      -webkit-background-clip: text; -webkit-text-fill-color: transparent;
      background-clip: text; animation: subtleHologram 5s ease-in-out infinite;
    }
    @keyframes subtleHologram {
      0%, 100% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
    }
    .danger-btn {
      background: linear-gradient(90deg, #f43f5e, #f59e42);
      color: white; border-radius: 1.2rem;
      padding: 0.9rem 2.5rem;
      font-weight: 700; font-size: 1.15rem;
      border: none;
      box-shadow: 0 2px 12px rgba(244,63,94,0.13);
      transition: background 0.3s, box-shadow 0.2s;
    }
    .danger-btn:hover {
      background: #d32f2f;
      box-shadow: 0 6px 24px rgba(244,63,94,0.21);
    }
    .mini-section-title {
      font-weight: 600;
      font-size: 1.05rem;
      color: #7c3aed;
      margin-top: 1.5rem;
      margin-bottom: 0.5rem;
    }
    .list-card {
      background: rgba(243,244,246,0.7);
      border-radius: 1.2rem;
      padding: 0.8rem 1.3rem;
      margin-bottom: 0.7rem;
      box-shadow: 0 1px 6px rgba(99,102,241,0.07);
      font-size: 1.01rem;
      color: #334155;
      font-weight: 500;
    }
  </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">

  <div class="glass max-w-lg w-full mt-20 p-10 shadow-xl flex flex-col gap-9">
    <!-- 타이틀 -->
    <h1 class="main-title text-4xl font-extrabold text-center mb-2">내 정보</h1>

    <!-- 회원정보 -->
    <section>
      <div class="flex flex-col gap-3 items-center">
        <div class="flex gap-4 items-center">
          <img id="user-avatar" src="https://ui-avatars.com/api/?name=User" alt="Avatar"
               class="w-20 h-20 rounded-full border-4 border-indigo-300 shadow-lg"/>
          <div>
            <div id="user-email" class="text-xl font-bold">user@email.com</div>
            <div id="user-uid" class="text-xs text-gray-400 break-all" style="display:none;">UID</div>
          </div>
        </div>
        <div id="joined-at" class="text-sm text-gray-500">가입일: --</div>
      </div>
    </section>

    <!-- 내 신청곡 통계 -->
    <section>
      <div class="mini-section-title">내 신청곡/즐겨찾기 통계</div>
      <div class="grid grid-cols-2 gap-3 text-center">
        <div class="flex flex-col gap-1 py-2 bg-white bg-opacity-50 rounded-lg shadow">
          <span class="text-lg font-bold text-indigo-500" id="my-total-requests">0</span>
          <span class="text-xs text-gray-600">신청곡 수</span>
        </div>
        <div class="flex flex-col gap-1 py-2 bg-white bg-opacity-50 rounded-lg shadow">
          <span class="text-lg font-bold text-pink-500" id="my-fav-count">0</span>
          <span class="text-xs text-gray-600">즐겨찾기</span>
        </div>
      </div>
    </section>

    <div class="mini-section-title mt-8">즐겨찾기 곡</div>
    <div id="fav-songs-list" class="mb-6"></div>

    <!-- 탈퇴 버튼 -->
    <section class="flex flex-col items-center gap-2 mt-8">
      <button id="withdraw-btn" class="danger-btn w-full">회원 탈퇴</button>
      <span class="text-xs text-gray-400">탈퇴 시 모든 정보가 삭제됩니다.</span>
    </section>
  </div>

</body>
</html>

<!-- ====== 모듈 스크립트: supabaseConfig.js에서 값 import ====== -->
<script type="module">
import { SUPABASE_URL, SUPABASE_ANON_KEY } from './supabaseConfig.js';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

function formatDate(dt) {
  if (!dt) return '-';
  const d = new Date(dt);
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

async function loadProfileAndFavorites() {
  const { data: { user }, error: userErr } = await supabase.auth.getUser();
  if (userErr || !user) {
    alert('로그인이 필요합니다.');
    window.location.href = '/login.html';
    return;
  }

  document.getElementById('user-email').textContent = user.email || '(이메일 없음)';
  document.getElementById('user-uid').textContent = user.id || '';
  document.getElementById('joined-at').textContent = '가입일: ' + formatDate(user.created_at);

  document.getElementById('user-avatar').src =
    user.user_metadata?.avatar_url ||
    `https://ui-avatars.com/api/?name=${encodeURIComponent(user.email||'User')}`;

  // 즐겨찾기 목록 로드
  const { data: profile } = await supabase
    .from('user_profile_stats')
    .select('favorites')
    .eq('user_id', user.id)
    .maybeSingle();

  const favList = Array.isArray(profile?.favorites) ? profile.favorites : [];
  document.getElementById('my-fav-count').textContent = favList.length;

  let favSongTitles = [];
  if (favList.length > 0) {
    const { data: songs } = await supabase
      .from('onusongdb')
      .select('id, title, artist')
      .in('id', favList.map(Number));
    favSongTitles = songs?.map(s => `${s.title} — ${s.artist}`) || [];
  }

  const favSongsListElem = document.getElementById('fav-songs-list');
  favSongsListElem.innerHTML = '';

  if (favSongTitles.length === 0) {
    favSongsListElem.innerHTML = '<div class="list-card text-gray-400">즐겨찾기 곡이 없습니다.</div>';
  } else {
    favSongTitles.forEach(t =>
      favSongsListElem.innerHTML += `<div class="list-card">${t}</div>`
    );
  }
}

document.addEventListener('DOMContentLoaded', loadProfileAndFavorites);
</script>

<!-- ===== 회원 탈퇴 기능 ===== -->
<script type="module">
import { SUPABASE_URL, SUPABASE_ANON_KEY } from './supabaseConfig.js';

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('withdraw-btn').onclick = async function() {
    if (!confirm('정말로 회원 탈퇴하시겠습니까? 모든 정보(즐겨찾기 등)가 삭제됩니다. 계정 자체는 남습니다.')) return;

    const { data: { user }, error: userErr } = await supabase.auth.getUser();
    if (userErr || !user) {
      alert('로그인이 필요합니다.');
      window.location.href = '/login.html';
      return;
    }

    const { error: dbErr } = await supabase
      .from('user_profile_stats')
      .delete()
      .eq('user_id', user.id);

    if (dbErr) {
      alert('DB 정보 삭제 실패: ' + dbErr.message);
      return;
    }

    await supabase.auth.signOut();
    alert('회원 정보가 삭제되었습니다.');
    window.location.href = '/';
  };
});
</script>
